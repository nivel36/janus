-- Copyright 2026 Abel Ferrer Jiménez
-- Licensed under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
--     http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing, software
-- distributed under the License is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.

-- ====================================================================
-- Schema: Janus
-- Engine: H2 (PostgreSQL compatibility mode)
-- Notes:
--  - IDENTITY columns for primary keys
--  - Foreign keys use ON DELETE RESTRICT
--  - Logical deletion via DELETED where applicable
--  - TIME_LOG.WORKSHIFT_ID models a strict 1→N relation
--  - Targeted indexes for joins and lookups
-- ====================================================================

-- Cleanup phase (drop in reverse dependency order)
DROP TABLE IF EXISTS CLOCK_OUT_WITHOUT_CLOCK_IN_EVENT;
DROP TABLE IF EXISTS EMPLOYEE_WORKSITE;
DROP TABLE IF EXISTS TIME_LOG;
DROP TABLE IF EXISTS WORK_SHIFT;
DROP TABLE IF EXISTS EMPLOYEE;
DROP TABLE IF EXISTS WORKSITE;
DROP TABLE IF EXISTS DAY_OF_WEEK_TIME_RANGE;
DROP TABLE IF EXISTS SCHEDULE_RULE;
DROP TABLE IF EXISTS SCHEDULE;
DROP TABLE IF EXISTS APP_USER;

-- ============================================================
-- APP_USER
-- Application users and their preferences.
-- ============================================================
CREATE TABLE APP_USER (
  ID            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USERNAME      VARCHAR(50)  NOT NULL,
  NAME          VARCHAR(255) NOT NULL,
  SURNAME       VARCHAR(255) NOT NULL,
  PASSWORD_HASH VARCHAR(64)  NOT NULL,
  LOCALE        VARCHAR(64)  NOT NULL,
  TIME_FORMAT   VARCHAR(16)  NOT NULL,
  CONSTRAINT UK_APP_USER_USERNAME UNIQUE (USERNAME)
);

-- ============================================================
-- SCHEDULE
-- Master catalog of available schedules.
-- NAME and CODE are unique identifiers.
-- ============================================================
CREATE TABLE SCHEDULE (
  ID            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NAME          VARCHAR(255) NOT NULL,
  CODE          VARCHAR(50)  NOT NULL,
  CONSTRAINT UK_SCHEDULE_NAME UNIQUE (NAME),
  CONSTRAINT UK_SCHEDULE_CODE UNIQUE (CODE)
);

-- ============================================================
-- SCHEDULE_RULE
-- Date-bounded rule sets belonging to a SCHEDULE.
-- START_DATE and END_DATE define optional validity windows.
-- ============================================================
CREATE TABLE SCHEDULE_RULE (
  ID            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NAME          VARCHAR(255),
  SCHEDULE_ID   BIGINT NOT NULL,
  START_DATE    DATE,
  END_DATE      DATE,
  CONSTRAINT UK_SCHEDULE_RULE_NAME UNIQUE (NAME),
  CONSTRAINT FK_SCHEDULE_RULE_SCHEDULE
    FOREIGN KEY (SCHEDULE_ID) REFERENCES SCHEDULE(ID) ON DELETE RESTRICT,
  CONSTRAINT CK_SCHEDULE_RULE_DATES
    CHECK (END_DATE IS NULL OR START_DATE IS NULL OR END_DATE >= START_DATE)
);

CREATE INDEX IDX_SCHEDULE_RULE_NAME ON SCHEDULE_RULE(NAME);
CREATE INDEX IDX_SCHEDULE_RULE_SCHED_DATES ON SCHEDULE_RULE(SCHEDULE_ID, START_DATE, END_DATE);

-- ============================================================
-- DAY_OF_WEEK_TIME_RANGE
-- Weekly time windows for a given SCHEDULE_RULE.
-- One range per day per rule.
-- ============================================================
CREATE TABLE DAY_OF_WEEK_TIME_RANGE (
  ID               BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  SCHEDULE_RULE_ID BIGINT NOT NULL,
  DAY_OF_WEEK      VARCHAR(16) NOT NULL,
  START_TIME       TIME NOT NULL,
  END_TIME         TIME NOT NULL,
  EFFECTIVE_WORK_HOURS VARCHAR(16) NOT NULL, 
  CONSTRAINT FK_DOWTR_RULE
    FOREIGN KEY (SCHEDULE_RULE_ID) REFERENCES SCHEDULE_RULE(ID) ON DELETE RESTRICT,
  CONSTRAINT UK_DOWTR_RULE_DAY
    UNIQUE (SCHEDULE_RULE_ID, DAY_OF_WEEK),
  CONSTRAINT CK_DOWTR_DAY
    CHECK (DAY_OF_WEEK IN ('MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY','SUNDAY')),
  CONSTRAINT CK_DOWTR_TIME_ORDER
    CHECK (END_TIME > START_TIME)
);

CREATE INDEX IDX_DOWTR_DOW ON DAY_OF_WEEK_TIME_RANGE(DAY_OF_WEEK);
CREATE INDEX IDX_DOWTR_RULE ON DAY_OF_WEEK_TIME_RANGE(SCHEDULE_RULE_ID);

-- ============================================================
-- WORKSITE
-- Physical or virtual work locations with an IANA time zone.
-- Logical deletion supported via DELETED flag.
-- ============================================================
CREATE TABLE WORKSITE (
  ID            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NAME          VARCHAR(255) NOT NULL,
  CODE          VARCHAR(50)  NOT NULL,
  TIME_ZONE     VARCHAR(64)  NOT NULL,
  DELETED       BOOLEAN NOT NULL DEFAULT FALSE,
  CONSTRAINT UK_WORKSITE_CODE UNIQUE (CODE)
);

-- ============================================================
-- EMPLOYEE
-- Registered employees. Each one is assigned a SCHEDULE.
-- ============================================================
CREATE TABLE EMPLOYEE (
  ID            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NAME          VARCHAR(255) NOT NULL,
  SURNAME       VARCHAR(255) NOT NULL,
  EMAIL         VARCHAR(254) NOT NULL,
  SCHEDULE_ID   BIGINT NOT NULL,
  CONSTRAINT UK_EMPLOYEE_EMAIL UNIQUE (EMAIL),
  CONSTRAINT FK_EMPLOYEE_SCHEDULE
    FOREIGN KEY (SCHEDULE_ID) REFERENCES SCHEDULE(ID) ON DELETE RESTRICT
);

-- Indexes for joins
CREATE INDEX IDX_EMPLOYEE_SCHEDULE ON EMPLOYEE(SCHEDULE_ID);
CREATE INDEX IDX_EMPLOYEE_EMAIL ON EMPLOYEE(EMAIL);

-- ============================================================
-- TIME_LOG
-- Individual check-in / check-out events.
-- EXIT_TIME remains NULL until the log is closed.
-- ============================================================
CREATE TABLE TIME_LOG (
  ID            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EMPLOYEE_ID   BIGINT NOT NULL,
  WORKSITE_ID   BIGINT NOT NULL,
  WORKSHIFT_ID  BIGINT,
  ENTRY_TIME    TIMESTAMP NOT NULL,
  EXIT_TIME     TIMESTAMP,
  WORK_DURATION VARCHAR(16),
  DELETED       BOOLEAN NOT NULL DEFAULT FALSE,
  CONSTRAINT FK_TIMELOG_EMPLOYEE
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(ID) ON DELETE RESTRICT,
  CONSTRAINT FK_TIMELOG_WORKSITE
    FOREIGN KEY (WORKSITE_ID) REFERENCES WORKSITE(ID) ON DELETE RESTRICT,
  CONSTRAINT FK_TIMELOG_WORKSHIFT
    FOREIGN KEY (WORKSHIFT_ID) REFERENCES WORK_SHIFT(ID) ON DELETE RESTRICT,
  CONSTRAINT CK_TIMELOG_TIME_ORDER
    CHECK (EXIT_TIME IS NULL OR EXIT_TIME > ENTRY_TIME)
);

-- Indexes for frequent lookups
CREATE INDEX IDX_TIMELOG_WORKSITE ON TIME_LOG(WORKSITE_ID);
CREATE INDEX IDX_TIMELOG_ENTRY ON TIME_LOG(ENTRY_TIME);
CREATE INDEX IDX_TIMELOG_EMP_ENTRY ON TIME_LOG(EMPLOYEE_ID, ENTRY_TIME);
CREATE INDEX IDX_TIMELOG_EMPLOYEE_WORKSITE_ENTRY ON TIME_LOG(EMPLOYEE_ID, WORKSITE_ID, ENTRY_TIME);
CREATE INDEX IDX_TIMELOG_DELETED_ENTRY ON TIME_LOG(DELETED, ENTRY_TIME);
CREATE INDEX IDX_TIMELOG_WORKSHIFT ON TIME_LOG(WORKSHIFT_ID);

-- ============================================================
-- WORK_SHIFT
-- Daily aggregate per employee. Durations stored in seconds.
-- Unique by EMPLOYEE_ID + DATE.
-- ============================================================
CREATE TABLE WORK_SHIFT (
  ID                 BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EMPLOYEE_ID        BIGINT NOT NULL,
  DATE               DATE   NOT NULL,
  TOTAL_PAUSE_TIME   VARCHAR(16) NOT NULL,
  TOTAL_WORK_TIME    VARCHAR(16) NOT NULL,
  CONSTRAINT FK_WORKSHIFT_EMPLOYEE
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(ID) ON DELETE RESTRICT,
  CONSTRAINT UK_WORKSHIFT_EMPLOYEE_DATE UNIQUE (EMPLOYEE_ID, DATE),
  CONSTRAINT CK_WORKSHIFT_DURATIONS
    CHECK (TOTAL_PAUSE_TIME >= 0 AND TOTAL_WORK_TIME >= 0)
);

CREATE INDEX IDX_WORKSHIFT_EMPLOYEE ON WORK_SHIFT(EMPLOYEE_ID);

-- ============================================================
-- EMPLOYEE_WORKSITE
-- Allowed worksites per employee (many-to-many).
-- ============================================================
CREATE TABLE EMPLOYEE_WORKSITE (
  EMPLOYEE_ID  BIGINT NOT NULL,
  WORKSITE_ID  BIGINT NOT NULL,
  CONSTRAINT PK_EMPLOYEE_WORKSITE PRIMARY KEY (EMPLOYEE_ID, WORKSITE_ID),
  CONSTRAINT FK_EW_EMPLOYEE
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(ID) ON DELETE RESTRICT,
  CONSTRAINT FK_EW_WORKSITE
    FOREIGN KEY (WORKSITE_ID) REFERENCES WORKSITE(ID) ON DELETE RESTRICT
);

CREATE INDEX IDX_EW_EMPLOYEE ON EMPLOYEE_WORKSITE(EMPLOYEE_ID);
CREATE INDEX IDX_EW_WORKSITE ON EMPLOYEE_WORKSITE(WORKSITE_ID);

-- ============================================================
-- CLOCK_OUT_WITHOUT_CLOCK_IN_EVENT
-- An exit action that cannot be matched to an existing timelog
-- ============================================================
CREATE TABLE CLOCK_OUT_WITHOUT_CLOCK_IN_EVENT (
  ID            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EMPLOYEE_ID   BIGINT NOT NULL,
  WORKSITE_ID   BIGINT NOT NULL,
  EXIT_TIME     TIMESTAMP NOT NULL,
  DETECTED_AT   TIMESTAMP NOT NULL,
  RESOLVED_TIMELOG_ID BIGINT,
  RESOLVED      BOOLEAN NOT NULL DEFAULT FALSE,
  INVALIDATED   BOOLEAN NOT NULL DEFAULT FALSE,
  REASON        VARCHAR(255),
  CONSTRAINT FK_CLOCKOUTWITHOUTCLOCKINEVENT_EMPLOYEE
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(ID) ON DELETE RESTRICT,
  CONSTRAINT FK_CLOCKOUTWITHOUTCLOCKINEVENT_WORKSITE
    FOREIGN KEY (WORKSITE_ID) REFERENCES WORKSITE(ID) ON DELETE RESTRICT,
  CONSTRAINT FK_CLOCKOUTWITHOUTCLOCKINEVENT_TIMELOG
    FOREIGN KEY (RESOLVED_TIMELOG_ID) REFERENCES TIME_LOG(ID) ON DELETE RESTRICT
);

-- Indexes for frequent lookups
CREATE INDEX IDX_CLOCKOUTWITHOUTCLOCKINEVENT_EXIT 
  ON CLOCK_OUT_WITHOUT_CLOCK_IN_EVENT(EXIT_TIME);
CREATE INDEX IDX_CLOCKOUTWITHOUTCLOCKINEVENT_EMPLOYEE_WORKSITE 
  ON CLOCK_OUT_WITHOUT_CLOCK_IN_EVENT(EMPLOYEE_ID, WORKSITE_ID);
